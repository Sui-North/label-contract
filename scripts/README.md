# Deployment & Upgrade Scripts

Automated scripts for deploying and upgrading the Songsim platform on Sui blockchain.

---

## Scripts Overview

### 1. `deploy.ps1` / `deploy.sh` - Initial Deployment

Deploys the Songsim platform to Sui testnet for the first time.

**Features:**
- ✅ Pre-flight checks (balance, network, Sui CLI)
- ✅ Automated build and test
- ✅ Package publication with gas estimation
- ✅ Automatic ID extraction (Package, UpgradeCap, AdminCap, shared objects)
- ✅ Generates `deployment.json` with all critical IDs
- ✅ Creates `.env.local.template` for frontend
- ✅ Colored output for easy reading

**Usage (Windows):**
```powershell
cd songsim/scripts
.\deploy.ps1
```

**Usage (Linux/Mac):**
```bash
cd songsim/scripts
chmod +x deploy.sh
./deploy.sh
```

**Prerequisites:**
- Sui CLI installed (`sui --version`)
- Active wallet with ≥0.1 SUI
- Network set to `testnet` (or confirm override)

**Output Files:**
- `deployment.json` - Complete deployment record
- `../songsim-label/.env.local.template` - Frontend configuration template

---

### 2. `upgrade.ps1` - Package Upgrade

Safely upgrades the deployed package with optional data migration.

**Features:**
- ✅ Loads existing deployment from `deployment.json`
- ✅ Network validation (prevents wrong network upgrades)
- ✅ Pre-upgrade build and tests
- ✅ Optional migration lock/unlock (3-phase pattern)
- ✅ Automatic version tracking
- ✅ Backup creation before upgrade
- ✅ Rollback instructions on failure

**Usage:**

**Simple Upgrade (No Migration):**
```powershell
.\upgrade.ps1 -NewVersion "1.1.0"
```

**Upgrade with Migration:**
```powershell
.\upgrade.ps1 -NewVersion "2.0.0" -RequiresMigration
```

**Skip Tests (Faster):**
```powershell
.\upgrade.ps1 -NewVersion "1.0.1" -SkipTests
```

**Parameters:**
- `-NewVersion` (optional): Semantic version (e.g., "1.2.0"). If omitted, prompts interactively.
- `-RequiresMigration` (switch): Enables 3-phase migration (lock → upgrade → unlock)
- `-SkipTests` (switch): Skips test suite (use only for hotfixes)

**What It Does:**

1. **Validation**: Loads `deployment.json`, checks network match
2. **Build & Test**: Compiles and runs test suite (unless `-SkipTests`)
3. **Migration Lock** (if `-RequiresMigration`):
   - Calls `begin_platform_migration()` → sets version to U64_MAX
   - Platform becomes read-only during upgrade
4. **Upgrade**: Executes `sui client upgrade --upgrade-capability <ID>`
5. **Migration Unlock** (if `-RequiresMigration`):
   - Calls `complete_platform_migration()` → sets new version
6. **Record**: Updates `deployment.json`, creates backup

**Output:**
- Updates `deployment.json` with new package ID and version
- Creates `deployment_backup_<version>.json`
- Prints transaction link and next steps

---

## File Structure

```
songsim/
├── scripts/
│   ├── deploy.ps1          # Windows deployment script
│   ├── deploy.sh           # Linux/Mac deployment script
│   ├── upgrade.ps1         # Windows upgrade script
│   └── README.md           # This file
├── deployment.json         # Generated by deploy.ps1 (DO NOT COMMIT)
├── deployment_backup_*.json # Generated by upgrade.ps1 (backups)
└── Move.toml              # Update published-at after deploy
```

---

## deployment.json Format

Generated by `deploy.ps1`, used by `upgrade.ps1`:

```json
{
  "network": "testnet",
  "version": "1.0.0",
  "deployedAt": "2025-01-15T10:30:00Z",
  "deployer": "0xYOUR_ADDRESS",
  "packageId": "0xPACKAGE_ID",
  "upgradeCap": "0xUPGRADE_CAP_ID",
  "adminCap": "0xADMIN_CAP_ID",
  "sharedObjects": {
    "platformConfig": "0xCONFIG_ID",
    "taskRegistry": "0xREGISTRY_ID",
    "migrationState": "0xMIGRATION_STATE_ID"
  },
  "transaction": {
    "digest": "TX_DIGEST",
    "explorerUrl": "https://suiscan.xyz/testnet/tx/TX_DIGEST"
  },
  "previousVersions": []  // Populated by upgrades
}
```

**⚠️ CRITICAL:** Never commit `deployment.json` to Git! Contains sensitive IDs.

---

## Upgrade Scenarios

### Scenario 1: Bug Fix (No Migration)

**Example:** Fix typo in error message, optimize function logic

```powershell
# Update code in sources/
.\upgrade.ps1 -NewVersion "1.0.1"
```

**What happens:**
- No migration lock (platform stays online)
- Package upgraded with same UpgradeCap
- Shared objects unchanged
- Zero downtime

---

### Scenario 2: New Feature (Compatible)

**Example:** Add new public function, add new struct

```powershell
# Add new module or function
.\upgrade.ps1 -NewVersion "1.1.0"
```

**Requirements:**
- ✅ Can add new structs
- ✅ Can add new public functions
- ❌ Cannot change existing struct fields
- ❌ Cannot change function signatures

---

### Scenario 3: Breaking Change (Requires Migration)

**Example:** Add field to `Task` struct, change consensus algorithm

```powershell
# Update sources/task.move (add field)
.\upgrade.ps1 -NewVersion "2.0.0" -RequiresMigration
```

**Migration Flow:**

1. **Lock Platform:**
   - `MigrationState.is_migrating = true`
   - `MigrationState.current_version = U64_MAX` (sentinel)
   - All operations validate version → fail during migration

2. **Upgrade Package:**
   - New package published
   - Old package ID still valid (for rollback)

3. **Run Migration Code:**
   - Manually call migration functions (see UPGRADE_GUIDE.md)
   - Example: `migrate_tasks_v1_to_v2()` updates all Task objects

4. **Unlock Platform:**
   - `complete_platform_migration()` sets new version
   - Operations resume with new code

**⚠️ Downtime:** Platform locked during migration (estimated: 5-30 minutes)

---

## Common Issues & Solutions

### Issue 1: "Insufficient balance"

**Error:**
```
✗ Insufficient balance. Need at least 0.1 SUI for deployment.
```

**Solution:**
1. Request testnet tokens: [Sui Discord Faucet](https://discord.com/channels/916379725201563759/971488439931392130)
2. Or use: `curl --location --request POST 'https://faucet.testnet.sui.io/v1/gas' --header 'Content-Type: application/json' --data-raw "{ \"FixedAmountRequest\": { \"recipient\": \"YOUR_ADDRESS\" } }"`

---

### Issue 2: "UpgradeCap not found"

**Error:** `upgrade.ps1` can't find UpgradeCap ID

**Solution:**
- Check `deployment.json` exists in `songsim/`
- Verify `upgradeCap` field is populated
- If lost, package becomes **immutable** (cannot upgrade)

---

### Issue 3: "Layout incompatible"

**Error:**
```
Error: Package upgrade failed. Layout incompatible.
```

**Cause:** Changed existing struct fields or function signatures

**Solution:**
1. Revert changes to maintain compatibility
2. OR add new fields/functions instead of modifying
3. OR use `-RequiresMigration` and write migration code

See [Sui Upgrade Compatibility Rules](https://docs.sui.io/guides/developer/advanced/upgrade-packages#compatibility-rules)

---

### Issue 4: Migration Lock Stuck

**Symptoms:** Platform locked (`version = U64_MAX`), but upgrade failed

**Recovery:**

```powershell
# Rollback migration (restores previous version)
sui client call `
  --package <OLD_PACKAGE_ID> `
  --module songsim `
  --function rollback_platform_migration `
  --args <ADMIN_CAP_ID> <MIGRATION_STATE_ID> `
  --gas-budget 10000000
```

**Prevention:**
- Always test migration code thoroughly before production
- Use testnet for trial runs
- Keep AdminCap secure for emergency rollbacks

---

## Security Checklist

### Before Deployment

- [ ] All tests passing (`sui move test`)
- [ ] Code reviewed by team
- [ ] Security audit completed (for mainnet)
- [ ] Gas budget sufficient (0.1 SUI minimum)
- [ ] Backup wallet seed phrase

### After Deployment

- [ ] Backup `deployment.json` to secure location
- [ ] Store UpgradeCap ID in password manager
- [ ] Store AdminCap ID in password manager
- [ ] Update `Move.toml` with `published-at`
- [ ] Update frontend `.env.local` with new IDs
- [ ] Test all functionality on frontend
- [ ] Document deployment in `DEPLOYMENT_HISTORY.md`

### Before Upgrade

- [ ] Backup current `deployment.json`
- [ ] Test upgrade on testnet first
- [ ] Announce maintenance window (if migration required)
- [ ] Verify UpgradeCap ownership
- [ ] Check AdminCap accessible

### After Upgrade

- [ ] Verify new package ID active
- [ ] Test all core functions (profile, task, consensus)
- [ ] Check frontend connects to new package
- [ ] Monitor for errors in first 24 hours
- [ ] Update documentation with breaking changes

---

## Best Practices

### Versioning Strategy

Follow [Semantic Versioning](https://semver.org/):

- **MAJOR (2.0.0)**: Breaking changes, requires migration
- **MINOR (1.1.0)**: New features, backwards compatible
- **PATCH (1.0.1)**: Bug fixes, backwards compatible

### Upgrade Frequency

- **Patch**: As needed for critical bugs
- **Minor**: Every 2-4 weeks (new features)
- **Major**: Quarterly or bi-annually (planned migrations)

### Testing Strategy

1. **Unit Tests**: All new code must have tests
2. **Integration Tests**: Test upgrade path on testnet
3. **Regression Tests**: Ensure existing features still work
4. **Manual QA**: Test frontend after every upgrade

### Rollback Plan

Always have a rollback strategy:

1. **Compatible Upgrades**: No rollback needed (old code still works)
2. **Migrations**: Keep migration rollback code
   - Example: `rollback_platform_migration()` restores old version
3. **Emergency**: Use AdminCap to pause platform, fix issue, resume

---

## Mainnet Deployment (Future)

**⚠️ DO NOT use these scripts for mainnet without modifications!**

### Required Changes:

1. **Security Audit**: Full code review by professional auditors
2. **Multi-Sig**: Use multi-signature wallet for AdminCap and UpgradeCap
3. **Governance**: Community approval for major upgrades
4. **Monitoring**: Real-time alerts for errors and anomalies
5. **Insurance**: Consider bug bounty program
6. **Gradual Rollout**: Canary deployments, feature flags

### Mainnet Checklist:

- [ ] Security audit completed (2+ firms)
- [ ] Bug bounty program active
- [ ] Multi-sig setup (3-of-5 or 5-of-7)
- [ ] Emergency pause tested
- [ ] Rollback procedures documented
- [ ] 24/7 monitoring configured
- [ ] Legal review completed
- [ ] Community governance in place

---

## Additional Resources

- **Sui Upgrade Guide**: https://docs.sui.io/guides/developer/advanced/upgrade-packages
- **Move Book - Packages**: https://move-book.com/advanced-topics/package-upgrades.html
- **Songsim Documentation**:
  - `../UPGRADE_GUIDE.md` - Detailed upgrade procedures
  - `../DEPLOYMENT_HISTORY.md` - Version history tracking
  - `../ESCROW_IMPLEMENTATION.md` - Security model
  - `../BLOCKCHAIN_INTEGRATION.md` - Frontend integration

---

## Support

**Issues or Questions?**
- GitHub Issues: [Repository Issues]
- Discord: [Community Server]
- Email: [Support Email]

**Emergency Contact (Mainnet Only):**
- On-Call Engineer: [Phone/Telegram]
- Incident Response: [Escalation Procedure]

---

**Last Updated:** November 20, 2025  
**Version:** 1.0.0  
**Maintained By:** Songsim Core Team
